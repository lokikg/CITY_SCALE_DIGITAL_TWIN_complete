services:
  - type: web
    name: city-iot-api
    env: python
    region: oregon  # Choose the region closest to your users
    buildCommand: cd backend && pip install -r requirements.txt
    startCommand: cd backend && alembic upgrade head && uvicorn server:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: DATABASE_URL
        sync: false  # Add the Neon database URL through the Render dashboard
      - key: PORT
        value: 8000
      - key: CORS_ORIGINS
        value: "https://your-vercel-app.vercel.app,http://localhost:3000"
        
  - type: worker
    name: city-iot-data-simulator
    env: python
    region: oregon
    buildCommand: cd backend && pip install -r requirements.txt
    startCommand: cd backend && python data_simulator.py
    envVars:
      - key: DATABASE_URL
        sync: false  # Add the Neon database URL through the Render dashboard
      - key: SIMULATION_INTERVAL_SECONDS
        value: 30
      - key: LOG_LEVEL
        value: INFO
      - key: BACKUP_ENABLED
        value: "true"
      # Add a connection to the web service for auto-wakeup
      - key: AUTO_WAKE_ON_REQUEST
        value: "true"

  - type: web
    name: city-iot-grafana
    env: docker
    region: oregon
    dockerfilePath: ./grafana/Dockerfile
    envVars:
      - key: GF_SECURITY_ADMIN_PASSWORD
        generateValue: true
      - key: GF_USERS_ALLOW_SIGN_UP
        value: "false"
      - key: GF_INSTALL_PLUGINS
        value: "grafana-clock-panel,grafana-simple-json-datasource,grafana-postgresql-datasource"
      # The following variables need to be set manually in the Render dashboard with Neon connection details
      - key: POSTGRES_HOST
        sync: false
      - key: POSTGRES_USER
        sync: false
      - key: POSTGRES_PASSWORD
        sync: false
      - key: POSTGRES_DB
        sync: false
